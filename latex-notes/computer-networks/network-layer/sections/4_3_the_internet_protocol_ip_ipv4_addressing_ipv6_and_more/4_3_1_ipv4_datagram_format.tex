\section{4.3.1 IPv4 Datagram Format}

\subsection{Concept Overview}

\begin{description}
    \item[Datagram:]
          \begin{enumerate}
              \item The Internet's network-layer packet is known as a \textbf{datagram}.
              \item Fundamental to understanding IP's operations.
              \item Format is defined in \textbf{RFC 791}.
              \item IPv4 datagram has a variable-length header:
                    \begin{itemize}
                        \item Typically 20 bytes long when no options are present.
                        \item Followed by a payload (data field).
                    \end{itemize}
              \item Composed of two main parts:
                    \begin{enumerate}
                        \item \textbf{Header:} Contains all information a router needs to make forwarding decisions.
                        \item \textbf{Data (Payload):} Contains the data being transported, typically a transport-layer segment (like TCP or UDP).
                    \end{enumerate}
          \end{enumerate}
\end{description}

\subsection{Technical Mechanism: The Datagram Format}

\begin{itemize}
    \item A textual representation of the IPv4 header:
          \begin{verbatim}
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identifier            |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time-to-Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source IP Address                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination IP Address                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options (if any) ...                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Data (Payload)                         |
|                             ...                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{verbatim}

    \item Key Header Fields and Their Purpose:
          \begin{enumerate}
              \item \textbf{Version (4 bits):}
                    \begin{enumerate}
                        \item Specifies IP protocol verstion
                        \item For IPv4, this is always 4.
                        \item Route examines this field first to know how to parse the rest of the header (e.g. to know that it should expect an IPv4 header, not IPv6 header)
                    \end{enumerate}
              \item \textbf{IHL (Internet Header Length) (4 bits):}
                    \begin{enumerate}
                        \item Specifies length of IP header in 32-bit words
                        \item Field is necessary because 'Options' field can make header variable-length
                        \item Required to find stasrt of a data/payload fields
                        \item Typical heder length is 20 bytes (5 words)
                    \end{enumerate}
              \item \textbf{Type of Service (TOS) (8 bits):} Indicates priority and routing preferences.
                    \begin{enumerate}
                        \item Included to allow different types of IP datagrams (e.g. real-time vs non-real time) to be distinguished and serviced differently (e.g. with priority or low-delay)
                        \item Bits are also used in Explicit Congestion Notification (ECN)
                    \end{enumerate}
              \item \textbf{Datagram Length (16 bits):} Length of the entire datagram (header + payload).
                    \begin{enumerate}
                        \item Total length of IP datagraam (header + payload) in bytes
                        \item Practial View:
                              \begin{enumerate}
                                  \item A 16-bit field allows for theoretical maximum datagram size of 65,535 bytes
                                  \item However, datagrams are rarely larger  than 1,500 bytes because they must fit within the Maximum Transmission Unit (MTU) of udnerlying link-layer to avoid fragmentation
                              \end{enumerate}
                    \end{enumerate}
              \item \textbf{Identifier, Flags, Fragmentation Offset (32 bits total):} Identifies fragments of the original datagram.
                    \begin{enumerate}
                        \item Fields are all used for IP fragmentation
                        \item If router needs to forward a datagram onto a link with an MTU smaller than datagram's size, it can "fragment" datagram into multiple smaller datagrams
                        \item Such smaller datagreams are reassembled only at final destination
                        \item This is a slow, complex process, and IPv6 gets rid of it entirely for routes
                    \end{enumerate}
              \item \textbf{Time-to-Live (TTL) (8 bits):} Limits the datagramâ€™s lifetime to prevent infinite loops.
                    \begin{enumerate}
                        \item Critical safety mechanism to ensure datagrams don't circulate forever in network (e.g. in a routing loop)
                        \item TTL field is decremented by one at every router is passes through
                        \item If router receives a datagram with a TTL of 1, it decrements it to 0, discards the datagram, and sends an ICMP error message back to source
                    \end{enumerate}
              \item \textbf{Protocol (8 bits):} Specifies the transport protocol in the payload (e.g., TCP, UDP).
                    \begin{enumerate}
                        \item Binds network layer to transport layer
                        \item Used only at final destination host to indicate which transport-layer protocol should receive datagram's payload
                              \begin{enumerate}
                                  \item 6 = TCP
                                  \item 17 = UDP
                                  \item 1 = ICMP (Internet Control Message Protocol)
                              \end{enumerate}
                    \end{enumerate}

              \item \textbf{Header Checksum (16 bits):} Error-checking for the header.
                    \begin{enumerate}
                        \item Performs error detection on header only, not on payload
                        \item Computed using 1s complement arithmetic over 2-byte units of the header
                        \item Must be recomputed at every router because TTL field changes
                        \item Why only header?
                              \begin{enumerate}
                                  \item Transport layer (TCP/UDP) performs its own checksum on payload
                                  \item TTL field changes at every route. Means header must be altered. Checksum must be recomputer and restored at every single router, which is time consuming
                              \end{enumerate}
                    \end{enumerate}
              \item \textbf{Source and Destination IP Address (32 bits each):} Addresses of originating and final destination interfaces
                    \begin{enumerate}
                        \item Fields contain 32-bit IP addresses of original src and final dest
                        \item Src address inserted by sending host
                        \item Dest address obtained from a DNS lookup
                    \end{enumerate}
              \item \textbf{Options (if any) (variable length):} Optional fields for control or security.
                    \begin{enumerate}
                        \item Field allows IP header to be extended, but rarely used
                        \item Can be problematic because makes header length variable, complkicating and slowing down router processing
                    \end{enumerate}
              \item \textbf{Data (Payload):} Actual transported data (e.g., TCP/UDP segment).
          \end{enumerate}
\end{itemize}

% TEMPLATE EXAMPLE
\subsection{Template Example}

\begin{itemize}
    \item X
          \begin{enumerate}
              \item Y
          \end{enumerate}
\end{itemize}
